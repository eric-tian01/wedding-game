<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<title>剧情游戏 - 多章节</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
<style>
*{ box-sizing:border-box; }
body{ margin:0; background:#000; color:#e5e7eb; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","PingFang SC","Microsoft YaHei",sans-serif; overflow:hidden; }

.bg{ position:fixed; inset:0; z-index:0; background:#000; }

#bgVideo{
  position:absolute; inset:0;
  width:100%; height:100%;
  object-fit: contain;
  background:#000;
}

.shade{ position:absolute; inset:0; background:linear-gradient(to bottom, rgba(0,0,0,0.04), rgba(0,0,0,0.30)); }

.chapter{
  position:fixed; top:18px; left:18px; z-index:4;
  font-weight:900; font-size:30px; letter-spacing:0.08em;
  color:#e5e7eb; text-shadow:0 6px 22px rgba(0,0,0,0.65);
}
.chapter small{ display:block; font-size:14px; opacity:0.75; letter-spacing:0.15em; margin-top:2px; }

.hud{
  position:fixed; top:14px; right:14px; z-index:4;
  display:flex; gap:10px; align-items:center;
  padding:10px 14px; border-radius:14px;
  background:rgba(15,23,42,.55);
  border:1px solid rgba(148,163,184,.35);
  backdrop-filter:blur(10px);
}
.scoreBox, .timerBox{ font-size:13px; }

button{
  cursor:pointer; border:none; border-radius:999px;
  padding:6px 12px; font-size:13px; color:#fff; background:#2563eb;
}
button.secondary{ background:rgba(15,23,42,.7); border:1px solid rgba(148,163,184,.35); }

.gate{
  position:fixed; inset:0; z-index:6;
  display:flex; justify-content:center; align-items:center;
  background:rgba(0,0,0,.55);
}
.gateCard{
  width:min(560px,92vw);
  border-radius:18px; padding:20px;
  background:rgba(15,23,42,.86);
  border:1px solid rgba(148,163,184,.35);
  text-align:center;
}
.gateCard h2{ margin:0 0 10px; }

.imgLayer{
  position:fixed; inset:0; z-index:5;
  display:none; justify-content:center; align-items:center;
  background:rgba(0,0,0,.45);
}
.imgStage{
  position:relative;
  width:min(1100px,96vw);
  aspect-ratio:2048/1152;
  background:#000;
  border-radius:14px;
  overflow:hidden;
}
.imgStage img{ position:absolute; inset:0; width:100%; height:100%; object-fit:contain; }
.hotspot{ position:absolute; cursor:pointer; }

.toast{
  position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
  z-index:7;
  background:rgba(15,23,42,.72);
  border:1px solid rgba(148,163,184,.35);
  backdrop-filter:blur(10px);
  padding:10px 12px;
  border-radius:12px;
  font-size:13px;
  display:none;
}

@media (orientation: portrait){
  :root{
    --vhVideo: 62vh;
    --pad: clamp(10px, 3vw, 16px);
  }
  #bgVideo, .shade{
    width:100vw;
    height: var(--vhVideo);
  }
  .chapter{
    top: var(--pad);
    left: var(--pad);
    font-size: clamp(18px, 5vw, 26px);
  }
  .hud{
    top: var(--pad);
    right: var(--pad);
  }
}
</style>
</head>
<body>

<div class="bg">
  <video id="bgVideo" playsinline webkit-playsinline x5-playsinline muted preload="auto"></video>
  <div class="shade"></div>
</div>

<div class="chapter" id="chapterTitle">
  第一章 · 初逢
  <small id="chapterEn">THE FIRST MEETING</small>
</div>

<div class="hud">
  <div class="scoreBox">积分：<b id="score">0</b></div>
  <div class="timerBox">用时：<b id="timer">00:00</b></div>
  <button id="btnReset" class="secondary">重置</button>
</div>

<div class="imgLayer" id="imgLayer">
  <div class="imgStage" id="imgStage">
    <img id="qImg" src="" alt="question"/>
  </div>
</div>

<div class="gate" id="gate">
  <div class="gateCard">
    <h2 id="gateH2">开始游戏</h2>
    <button id="btnStart">开始 ▶</button>
  </div>
</div>

<div class="toast" id="toast"></div>
<audio id="bgm" loop preload="auto"></audio>

<script>
const STORE = "wedding_game_v2";
// 阿里云 OSS 基础路径
const BASE_URL = "https://haibing-wedding-video.oss-cn-chengdu.aliyuncs.com/";

const CHAPTERS = [
  {
    id: "ch1",
    title: "第一章 · 初逢",
    en: "The First Meeting",
    bgm: BASE_URL + "bgm_ch1.mp3",
    videos: [
      BASE_URL + "chufeng_merge.mp4",
      BASE_URL + "cuoyiban1.mp4"
    ],
    questions: [
      {
        id: "q_trash_sell",
        after: BASE_URL + "chufeng_merge.mp4",
        img: BASE_URL + "xuanbanzhang.png",
        aspect: "2048/1152",
        hotspots: [
          { score: 0,  left:10, top:63, width:36, height:18, nextVideo: BASE_URL + "wrong_selection.mp4" },
          { score: 10, left:55, top:63, width:36, height:18, nextVideo: BASE_URL + "right_selection.mp4" }
        ]
      }
    ],
    nextChapterId: "ch2"
  },
  {
    id: "ch2",
    title: "第二章 · 相识",
    en: "Getting to Know You",
    bgm: BASE_URL + "bgm_ch2.mp3",
    videos: [BASE_URL + "mailaji.mp4", BASE_URL + "liulian.mp4", BASE_URL + "langsong.mp4"],
    questions: [
      {
        id: "q_ch2_jiasai",
        after: BASE_URL + "mailaji.mp4",
        img: BASE_URL + "trash_selling1.png",
        aspect: "2048/1152",
        hotspots: [
          { score: 0,  left:10, top:63, width:36, height:18, nextVideo: BASE_URL + "wrong_selection.mp4" },
          { score: 10, left:55, top:63, width:36, height:18, nextVideo: BASE_URL + "right_selection.mp4" }
        ]
      },
      {
        id: "q_ch2_trash_selling",
        after: BASE_URL + "langsong.mp4",
        img: BASE_URL + "jiasai.png",
        aspect: "2048/1152",
        hotspots: [
          { score: 10, left: 0,  top: 0, width: 50, height: 100, nextVideo: BASE_URL + "right_selection.mp4" },
          { score: 0,  left: 50, top: 0, width: 50, height: 100, nextVideo: BASE_URL + "wrong_selection.mp4" }
        ]
      }
    ],
    nextChapterId: "ch3"
  },
  {
    id: "ch3",
    title: "第三章 · 各行",
    en: "Finding Our Own Paths",
    bgm: BASE_URL + "bgm_ch3.mp3",
    videos: [BASE_URL + "gexing_merge13.mp4", BASE_URL + "gexing_merge15.mp4"],
    questions: [
      {
        id: "q_ch3_1_work",
        after: BASE_URL + "gexing_merge13.mp4",
        img: BASE_URL + "gongzuo.png",
        aspect: "2048/1188",
        hotspots: [
          { score: 0,  left:52.0, top:44.0, width:10.0, height:18.0, nextVideo: BASE_URL + "wrong_selection.mp4" },
          { score: 10, left:63.5, top:44.0, width:10.0, height:18.0, nextVideo: BASE_URL + "right_selection.mp4" },
          { score: 0,  left:75.5, top:44.0, width:10.0, height:18.0, nextVideo: BASE_URL + "wrong_selection.mp4" }
        ]
      }
    ],
    nextChapterId: "ch4"
  },
  {
    id: "ch4",
    title: "第四章 · 再会",
    en: "Reunion",
    bgm: BASE_URL + "bgm_ch4.mp3",
    videos: [BASE_URL + "zaihui_merge11.mp4", BASE_URL + "zaihui5.mp4"],
    questions: [
      {
        id: "q_ch4_beibao",
        after: BASE_URL + "zaihui_merge11.mp4",
        img: BASE_URL + "beibao.png",
        aspect: "2048/1143",
        hotspots: [
          { score: 0,  left: 4.3, top: 73.8, width: 12.4, height: 25.6, nextVideo: BASE_URL + "wrong_selection.mp4" },
          { score: 0,  left: 24.2, top: 73.9, width: 12.3, height: 25.5, nextVideo: BASE_URL + "wrong_selection.mp4" },
          { score: 0,  left: 43.8, top: 73.9, width: 12.3, height: 25.5, nextVideo: BASE_URL + "wrong_selection.mp4" },
          { score: 30, left: 62.7, top: 73.9, width: 12.3, height: 25.5, nextVideo: BASE_URL + "right_selection.mp4" },
          { score: 0,  left: 81.0, top: 73.9, width: 11.9, height: 25.5, nextVideo: BASE_URL + "wrong_selection.mp4" }
        ]
      }
    ],
    nextChapterId: "ch5"
  },
  {
    id: "ch5",
    title: "第五章 · 向前",
    en: "Moving Forward",
    bgm: BASE_URL + "bgm_ch5.mp3",
    videos: [BASE_URL + "xiangqian_merge.mp4", BASE_URL + "xiangqian11.mp4", BASE_URL + "xiangqian5.mp4"],
    questions: [
      {
        id: "q_ch5_xiangqian_guess",
        after: BASE_URL + "xiangqian_merge.mp4",
        img: BASE_URL + "yaoshi.png",
        aspect: "2048/1152",
        hotspots: [
          { score: 0,  left: 0,  top: 0, width: 50, height: 100, nextVideo: BASE_URL + "wrong_selection.mp4" },
          { score: 30, left: 50, top: 0, width: 50, height: 100, nextVideo: BASE_URL + "right_selection.mp4" }
        ]
      }
    ],
    nextChapterId: "ch6"
  },
  {
    id: "ch6",
    title: "第六章 · 经年",
    en: "Years Apart",
    bgm: BASE_URL + "bgm_ch6.mp3",
    videos: [BASE_URL + "jingnian_merge.mp4"],
    questions: [],
    nextChapterId: "ch7"
  },
  {
    id: "ch7",
    title: "第七章 · 此刻",
    en: "This Moment",
    bgm: BASE_URL + "bgm_ch7.mp3",
    videos: [BASE_URL + "cike1.mp4", BASE_URL + "cike2.mp4", BASE_URL + "cike3.mp4"],
    questions: [],
    nextChapterId: null
  }
];

/* 核心逻辑 */
const bgVideo = document.getElementById("bgVideo");
const bgm = document.getElementById("bgm");
const scoreEl = document.getElementById("score");
const timerEl = document.getElementById("timer");
const chapterTitle = document.getElementById("chapterTitle");
const chapterEn = document.getElementById("chapterEn");
const gate = document.getElementById("gate");
const gateH2 = document.getElementById("gateH2");
const imgLayer = document.getElementById("imgLayer");
const imgStage = document.getElementById("imgStage");
const qImg = document.getElementById("qImg");
const toast = document.getElementById("toast");

let curChapter = null, curVideoIndex = 0, endHandled = false, blockEnd = false;
let injectedActive = false, injectedReturnIndex = 0;

/* 存储辅助 */
function get(k){ return localStorage.getItem(`${STORE}:${k}`); }
function set(k,v){ localStorage.setItem(`${STORE}:${k}`, String(v)); }
function loadScore(){ return Number(get("score") || 0); }
function saveScore(v){ set("score", v); scoreEl.textContent = v; }
function answeredKey(chId, qid){ return `answered:${chId}:${qid}`; }
function isAnswered(chId, qid){ return get(answeredKey(chId, qid)) === "1"; }
function markAnswered(chId, qid){ set(answeredKey(chId, qid), "1"); }

function showToast(msg, ms=1400){
  toast.textContent = msg;
  toast.style.display = "block";
  setTimeout(()=> toast.style.display="none", ms);
}

/* 计时器 */
let timerTick = null;
function updateTimerUI(){
  const st = Number(get("timerStart") || 0);
  const sp = Number(get("timerStop") || 0);
  if (!st){ timerEl.textContent = "00:00"; return; }
  const elapsed = (sp>0 ? (sp - st) : (Date.now() - st));
  const s = Math.floor(elapsed/1000);
  const mm = Math.floor(s/60);
  const ss = s%60;
  timerEl.textContent = `${String(mm).padStart(2,"0")}:${String(ss).padStart(2,"0")}`;
}

/* 播放逻辑 */
function loadVideo(i){
  if (!curChapter) return;
  blockEnd = false; endHandled = false;
  curVideoIndex = i;
  if (curVideoIndex >= curChapter.videos.length){
    gotoNextChapter(); return;
  }
  bgVideo.src = curChapter.videos[curVideoIndex];
  bgVideo.load();
}

bgVideo.addEventListener("canplay", () => bgVideo.play().catch(()=>{}));

function handleEnd(){
  if (blockEnd || endHandled) return;
  endHandled = true;
  if (injectedActive){
    injectedActive = false;
    loadVideo(injectedReturnIndex); return;
  }
  const vidName = curChapter.videos[curVideoIndex];
  const q = (curChapter.questions || []).find(q => q.after === vidName);
  if (q && !isAnswered(curChapter.id, q.id)){
    setTimeout(()=> openQuestion(q), 100); return;
  }
  loadVideo(curVideoIndex + 1);
}

bgVideo.addEventListener("ended", handleEnd);

function openQuestion(q){
  blockEnd = true; 
  endHandled = true; // 进入答题模式，锁定视频跳转
  bgVideo.pause();
  
  qImg.src = q.img;
  imgStage.style.aspectRatio = q.aspect || "2048/1152";
  
  // 清除旧的热点
  imgStage.querySelectorAll(".hotspot").forEach(n => n.remove());
  
  q.hotspots.forEach(h => {
    const div = document.createElement("div");
    div.className = "hotspot";
    div.style.cssText = `left:${h.left}%; top:${h.top}%; width:${h.width}%; height:${h.height}%;`;
    
    div.onclick = () => {
      // 1. 处理积分
      if (!isAnswered(curChapter.id, q.id)){
        saveScore(loadScore() + h.score);
        markAnswered(curChapter.id, q.id);
      }
      
      // 2. 隐藏题目层
      imgLayer.style.display = "none";
      
      // ✅ 关键修复点：解除逻辑锁定
      blockEnd = false; 
      endHandled = false; 

      if (h.nextVideo){
        // 进入分支视频流程
        injectedActive = true; 
        injectedReturnIndex = curVideoIndex + 1;
        bgVideo.src = h.nextVideo; 
        bgVideo.load();
        // 在点击事件内直接触发 play，保证浏览器权限
        bgVideo.play().catch(e => console.log("播放被拦截:", e));
      } else {
        // 直接进入下一段视频
        loadVideo(curVideoIndex + 1);
      }
    };
    imgStage.appendChild(div);
  });
  imgLayer.style.display = "flex";
}
function startChapterById(chId){
  curChapter = CHAPTERS.find(c => c.id === chId);
  set("currentChapterId", chId);
  chapterTitle.childNodes[0].nodeValue = curChapter.title + "\n  ";
  chapterEn.textContent = curChapter.en;
  bgm.src = curChapter.bgm; bgm.play().catch(()=>{});
  loadVideo(0);
}

function gotoNextChapter(){
  if (!curChapter.nextChapterId){
    set("timerStop", Date.now()); clearInterval(timerTick);
    showToast("全剧终"); return;
  }
  const next = CHAPTERS.find(c => c.id === curChapter.nextChapterId);
  gate.style.display = "flex";
  gateH2.textContent = `进入 ${next.title}`;
  document.getElementById("btnStart").onclick = () => {
    gate.style.display = "none"; startChapterById(next.id);
  };
}

/* 初始化 */
saveScore(loadScore());
if (get("timerStart") && !get("timerStop")) timerTick = setInterval(updateTimerUI, 1000);

document.getElementById("btnStart").onclick = () => {
  gate.style.display = "none";
  if (!get("timerStart")) set("timerStart", Date.now());
  timerTick = setInterval(updateTimerUI, 1000);
  const last = get("currentChapterId");
  startChapterById(last || "ch1");
};

document.getElementById("btnReset").onclick = () => {
  if(confirm("重置所有进度？")){
    localStorage.clear(); location.reload();
  }
};
</script>
</body>
</html>
