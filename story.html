<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<title>剧情游戏 - 完整稳定版</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
<style>
*{ box-sizing:border-box; }
body{ margin:0; background:#000; color:#e5e7eb; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","PingFang SC","Microsoft YaHei",sans-serif; overflow:hidden; }

.bg{ position:fixed; inset:0; z-index:0; background:#000; }

#bgVideo{
  position:absolute; inset:0;
  width:100%; height:100%;
  object-fit: contain;
  background:#000;
}

.shade{ position:absolute; inset:0; background:linear-gradient(to bottom, rgba(0,0,0,0.04), rgba(0,0,0,0.30)); }

.chapter{
  position:fixed; top:18px; left:18px; z-index:4;
  font-weight:900; font-size:30px; letter-spacing:0.08em;
  color:#e5e7eb; text-shadow:0 6px 22px rgba(0,0,0,0.65);
}
.chapter small{ display:block; font-size:14px; opacity:0.75; letter-spacing:0.15em; margin-top:2px; }

.hud{
  position:fixed; top:14px; right:14px; z-index:4;
  display:flex; gap:10px; align-items:center;
  padding:10px 14px; border-radius:14px;
  background:rgba(15,23,42,.55);
  border:1px solid rgba(148,163,184,.35);
  backdrop-filter:blur(10px);
}
.scoreBox, .timerBox{ font-size:13px; }

button{
  cursor:pointer; border:none; border-radius:999px;
  padding:6px 16px; font-size:13px; color:#fff; background:#2563eb; font-weight:bold;
}
button.secondary{ background:rgba(15,23,42,.7); border:1px solid rgba(148,163,184,.35); }

.gate{
  position:fixed; inset:0; z-index:6;
  display:flex; justify-content:center; align-items:center;
  background:rgba(0,0,0,.8);
}
.gateCard{
  width:min(560px,92vw);
  border-radius:18px; padding:30px;
  background:rgba(15,23,42,.95);
  border:1px solid rgba(148,163,184,.35);
  text-align:center;
}
.gateCard h2{ margin:0 0 15px; }

.imgLayer{
  position:fixed; inset:0; z-index:5;
  display:none; justify-content:center; align-items:center;
  background:rgba(0,0,0,.6);
}
.imgStage{
  position:relative;
  width:min(1100px,96vw);
  aspect-ratio:2048/1152;
  background:#000;
  border-radius:14px;
  overflow:hidden;
  border: 2px solid #3b82f6;
}
.imgStage img{ position:absolute; inset:0; width:100%; height:100%; object-fit:contain; }
.hotspot{ position:absolute; cursor:pointer; background: rgba(255,255,255,0); }

.toast{
  position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
  z-index:7;
  background:rgba(15,23,42,.8);
  padding:10px 20px;
  border-radius:12px;
  font-size:14px;
  display:none;
}

@media (orientation: portrait){
  #bgVideo, .shade { height: 65vh; top: 10vh; }
  .chapter { font-size: 22px; }
}
</style>
</head>
<body>

<div class="bg">
  <video id="bgVideo" playsinline webkit-playsinline x5-playsinline preload="auto"></video>
  <div class="shade"></div>
</div>

<div class="chapter" id="chapterTitle">
  第一章 · 初逢
  <small id="chapterEn">THE FIRST MEETING</small>
</div>

<div class="hud">
  <div class="scoreBox">积分：<b id="score">0</b></div>
  <div class="timerBox">用时：<b id="timer">00:00</b></div>
  <button id="btnReset" class="secondary">重置</button>
</div>

<div class="imgLayer" id="imgLayer">
  <div class="imgStage" id="imgStage">
    <img id="qImg" src="" alt="question"/>
  </div>
</div>

<div class="gate" id="gate">
  <div class="gateCard">
    <h2 id="gateH2">准备好了吗？</h2>
    <button id="btnStart">开始游戏 ▶</button>
  </div>
</div>

<div class="toast" id="toast"></div>
<audio id="bgm" loop preload="auto"></audio>

<script>
/* --- 配置区 --- */
const STORE = "wedding_game_v2";
const BASE_URL = "https://haibing-wedding-video.oss-cn-chengdu.aliyuncs.com/";
const GLOBAL_BGM = BASE_URL + "love_story.mp3"; 
const GLOBAL_BGM_VOLUME = 0.35;

const CHAPTERS = [
  {
    id: "ch1", title: "第一章 · 初逢", en: "THE FIRST MEETING",
    videos: [BASE_URL + "chufeng_merge.mp4", BASE_URL + "cuoyiban1.mp4"],
    questions: [{
      id: "q_trash_sell", after: BASE_URL + "chufeng_merge.mp4", img: BASE_URL + "xuanbanzhang.png",
      hotspots: [
        { score: 0,  left:10, top:60, width:36, height:25, nextVideo: BASE_URL + "wrong_selection.mp4" },
        { score: 10, left:55, top:60, width:36, height:25, nextVideo: BASE_URL + "right_selection.mp4" }
      ]
    }],
    nextChapterId: "ch2"
  },
  {
    id: "ch2", title: "第二章 · 相识", en: "GETTING TO KNOW YOU",
    videos: [BASE_URL + "mailaji.mp4", BASE_URL + "liulian.mp4", BASE_URL + "langsong.mp4"],
    questions: [
      { id: "q_ch2_jiasai", after: BASE_URL + "mailaji.mp4", img: BASE_URL + "trash_selling1.png",
        hotspots: [
          { score: 0,  left:10, top:60, width:36, height:25, nextVideo: BASE_URL + "wrong_selection.mp4" },
          { score: 10, left:55, top:60, width:36, height:25, nextVideo: BASE_URL + "right_selection.mp4" }
        ]
      },
      { id: "q_ch2_trash_selling", after: BASE_URL + "langsong.mp4", img: BASE_URL + "jiasai.png",
        hotspots: [
          { score: 10, left: 0,  top: 0, width: 50, height: 100, nextVideo: BASE_URL + "right_selection.mp4" },
          { score: 0,  left: 50, top: 0, width: 50, height: 100, nextVideo: BASE_URL + "wrong_selection.mp4" }
        ]
      }
    ],
    nextChapterId: "ch3"
  },
  {
    id: "ch3", title: "第三章 · 各行", en: "FINDING OUR OWN PATHS",
    videos: [BASE_URL + "gexing_merge13.mp4", BASE_URL + "gexing_merge15.mp4"],
    questions: [{
      id: "q_ch3_1_work", after: BASE_URL + "gexing_merge13.mp4", img: BASE_URL + "gongzuo.png",
      hotspots: [
        { score: 0,  left:52, top:44, width:10, height:18, nextVideo: BASE_URL + "wrong_selection.mp4" },
        { score: 10, left:63, top:44, width:10, height:18, nextVideo: BASE_URL + "right_selection.mp4" },
        { score: 0,  left:75, top:44, width:10, height:18, nextVideo: BASE_URL + "wrong_selection.mp4" }
      ]
    }],
    nextChapterId: "ch4"
  },
  {
    id: "ch4", title: "第四章 · 再会", en: "REUNION",
    videos: [BASE_URL + "zaihui_merge11.mp4", BASE_URL + "zaihui5.mp4"],
    questions: [{
      id: "q_ch4_beibao", after: BASE_URL + "zaihui_merge11.mp4", img: BASE_URL + "beibao.png",
      hotspots: [
        { score: 30, left: 62.7, top: 73.9, width: 12.3, height: 25.5, nextVideo: BASE_URL + "right_selection.mp4" },
        { score: 0,  left: 5, top: 73.9, width: 50, height: 25.5, nextVideo: BASE_URL + "wrong_selection.mp4" }
      ]
    }],
    nextChapterId: "ch5"
  },
  {
    id: "ch5", title: "第五章 · 向前", en: "MOVING FORWARD",
    videos: [BASE_URL + "xiangqian_merge.mp4", BASE_URL + "xiangqian11.mp4", BASE_URL + "xiangqian5.mp4"],
    questions: [{
      id: "q_ch5_xiangqian_guess", after: BASE_URL + "xiangqian_merge.mp4", img: BASE_URL + "yaoshi.png",
      hotspots: [
        { score: 0,  left: 0,  top: 0, width: 50, height: 100, nextVideo: BASE_URL + "wrong_selection.mp4" },
        { score: 30, left: 50, top: 0, width: 50, height: 100, nextVideo: BASE_URL + "right_selection.mp4" }
      ]
    }],
    nextChapterId: "ch6"
  },
  { id: "ch6", title: "第六章 · 经年", en: "YEARS APART", videos: [BASE_URL + "jingnian_merge.mp4"], questions: [], nextChapterId: "ch7" },
  { id: "ch7", title: "第七章 · 此刻", en: "THIS MOMENT", videos: [BASE_URL + "cike1.mp4", BASE_URL + "cike2.mp4", BASE_URL + "cike3.mp4"], questions: [], nextChapterId: null }
];

/* --- 核心逻辑 --- */
const bgVideo = document.getElementById("bgVideo");
const bgm = document.getElementById("bgm");
const scoreEl = document.getElementById("score");
const timerEl = document.getElementById("timer");
const chapterTitle = document.getElementById("chapterTitle");
const chapterEn = document.getElementById("chapterEn");
const gate = document.getElementById("gate");
const imgLayer = document.getElementById("imgLayer");
const imgStage = document.getElementById("imgStage");
const qImg = document.getElementById("qImg");
const toast = document.getElementById("toast");

let curChapter = null, curVideoIndex = 0, endHandled = false, blockEnd = false;
let injectedActive = false, injectedReturnIndex = 0;

function switchVideo(url) {
  blockEnd = false;
  endHandled = false;
  bgVideo.pause();
  bgVideo.src = url;
  bgVideo.load();
  bgVideo.play().catch(e => console.log("播放被拦截:", e));
}

function loadMainVideo(i) {
  if (!curChapter) return;
  if (i >= curChapter.videos.length) {
    gotoNextChapter();
    return;
  }
  curVideoIndex = i;
  switchVideo(curChapter.videos[curVideoIndex]);
}

function handleEnd() {
  if (blockEnd || endHandled) return;
  endHandled = true;

  if (injectedActive) {
    injectedActive = false;
    loadMainVideo(injectedReturnIndex);
    return;
  }

  const vidName = curChapter.videos[curVideoIndex];
  const q = (curChapter.questions || []).find(q => q.after === vidName);
  if (q && !isAnswered(curChapter.id, q.id)) {
    setTimeout(() => openQuestion(q), 100);
    return;
  }
  loadMainVideo(curVideoIndex + 1);
}

bgVideo.addEventListener("ended", handleEnd);

function openQuestion(q) {
  blockEnd = true;
  endHandled = true;
  bgVideo.pause();
  qImg.src = q.img;
  
  imgStage.querySelectorAll(".hotspot").forEach(n => n.remove());
  q.hotspots.forEach(h => {
    const div = document.createElement("div");
    div.className = "hotspot";
    div.style.cssText = `left:${h.left}%; top:${h.top}%; width:${h.width}%; height:${h.height}%;`;
    div.onclick = (e) => {
      e.stopPropagation();
      if (!isAnswered(curChapter.id, q.id)) {
        saveScore(loadScore() + h.score);
        markAnswered(curChapter.id, q.id);
      }
      imgLayer.style.display = "none";
      
      if (h.nextVideo) {
        injectedActive = true;
        injectedReturnIndex = curVideoIndex + 1;
        switchVideo(h.nextVideo);
      } else {
        loadMainVideo(curVideoIndex + 1);
      }
    };
    imgStage.appendChild(div);
  });
  imgLayer.style.display = "flex";
}

/* --- 存储与工具 --- */
function get(k){ return localStorage.getItem(`${STORE}:${k}`); }
function set(k,v){ localStorage.setItem(`${STORE}:${k}`, String(v)); }
function loadScore(){ return Number(get("score") || 0); }
function saveScore(v){ set("score", v); scoreEl.textContent = v; }
function isAnswered(chId, qid){ return get(`answered:${chId}:${qid}`) === "1"; }
function markAnswered(chId, qid){ set(`answered:${chId}:${qid}`, "1"); }
function showToast(msg){ toast.textContent = msg; toast.style.display="block"; setTimeout(()=>toast.style.display="none", 2000); }

let timerTick = null;

// ✅ 核心修复：更新计时逻辑，支持停止时间
function updateTimerUI(){
  const st = Number(get("timerStart") || 0);
  const sp = Number(get("timerStop") || 0); // 获取停止时间戳
  if (!st){ timerEl.textContent = "00:00"; return; }
  
  // 如果有停止时间，则使用停止时间计算，否则用当前时间
  const now = sp > 0 ? sp : Date.now();
  const elapsed = now - st;
  
  const s = Math.floor(elapsed/1000);
  const mm = Math.floor(s/60);
  const ss = s%60;
  timerEl.textContent = `${String(mm).padStart(2,"0")}:${String(ss).padStart(2,"0")}`;
}

function startChapterById(chId) {
  curChapter = CHAPTERS.find(c => c.id === chId);
  set("currentChapterId", chId);
  chapterTitle.childNodes[0].nodeValue = curChapter.title + " ";
  chapterEn.textContent = curChapter.en;
  loadMainVideo(0);
}

// ✅ 核心修复：全剧终时记录停止时间并清除定时器
function gotoNextChapter() {
  if (!curChapter.nextChapterId) {
    // 判定为全剧终
    if (!get("timerStop")) {
      set("timerStop", Date.now()); // 记录这一刻的时间戳
    }
    if (timerTick) clearInterval(timerTick); // 停止每秒更新 UI
    updateTimerUI(); // 最后刷新一次确保显示准确
    showToast("全剧终！感谢观看");
    return;
  }
  const next = CHAPTERS.find(c => c.id === curChapter.nextChapterId);
  gate.style.display = "flex";
  document.getElementById("gateH2").textContent = `通关成功！进入 ${next.title}`;
  document.getElementById("btnStart").onclick = () => {
    gate.style.display = "none";
    startChapterById(next.id);
  };
}

/* --- 初始化 --- */
saveScore(loadScore());

document.getElementById("btnStart").onclick = () => {
  gate.style.display = "none";
  
  if (!bgm.src || bgm.src === "") {
    bgm.src = GLOBAL_BGM;
    bgm.volume = GLOBAL_BGM_VOLUME;
    bgm.play().catch(e => console.log("BGM 播放受阻:", e));
  }
  bgVideo.muted = false;

  // 只有在没开始计时，或没结束计时的情况下才运行定时器
  if (!get("timerStart")) set("timerStart", Date.now());
  
  if (!get("timerStop")) {
    if (!timerTick) timerTick = setInterval(updateTimerUI, 1000);
  } else {
    updateTimerUI(); // 即使结束了也显示最终固定的时间
  }
  
  const last = get("currentChapterId");
  startChapterById(last || "ch1");
};

document.getElementById("btnReset").onclick = () => {
  if(confirm("确定重置所有进度吗？")) { 
    localStorage.clear(); 
    if (timerTick) clearInterval(timerTick);
    location.reload(); 
  }
};

// 页面加载时根据状态显示一次计时
updateTimerUI();
</script>
</body>
</html>
