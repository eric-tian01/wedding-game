<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<title>å‰§æƒ…æ¸¸æˆ - æ­¤åˆ»ä¹‹å‰</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
<style>
*{ box-sizing:border-box; }
body{ margin:0; background:#000; color:#e5e7eb; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","PingFang SC","Microsoft YaHei",sans-serif; overflow:hidden; }

.bg{ position:fixed; inset:0; z-index:0; background:#000; }

#bgVideo{
  position:absolute; inset:0;
  width:100%; height:100%;
  object-fit: contain;
  background:#000;
}

.shade{ position:absolute; inset:0; background:linear-gradient(to bottom, rgba(0,0,0,0.04), rgba(0,0,0,0.30)); }

.chapter{
  position:fixed; top:18px; left:18px; z-index:4;
  font-weight:900; font-size:24px; letter-spacing:0.08em;
  color:#e5e7eb; text-shadow:0 4px 15px rgba(0,0,0,0.8);
}
.chapter small{ display:block; font-size:12px; opacity:0.75; letter-spacing:0.15em; margin-top:2px; }

/* HUD åŸºç¡€æ ·å¼ */
.hud{
  position:fixed; top:14px; right:14px; z-index:4;
  display:flex; gap:20px; align-items:center;
  padding:10px 20px; border-radius:14px;
  background:rgba(15,23,42,.65);
  border:1px solid rgba(148,163,184,.35);
  backdrop-filter:blur(10px);
}
.scoreBox, .timerBox{ font-size:14px; font-weight: bold; }

button#btnStart {
  cursor:pointer; border:none; border-radius:999px;
  padding:10px 24px; font-size:15px; color:#fff; background:#2563eb; font-weight:bold;
  box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
}

.gate{
  position:fixed; inset:0; z-index:6;
  display:flex; justify-content:center; align-items:center;
  background:rgba(0,0,0,.8);
}
.gateCard{
  width:min(560px,92vw);
  border-radius:18px; padding:30px;
  background:rgba(15,23,42,.95);
  border:1px solid rgba(148,163,184,.35);
  text-align:center;
}
.gateCard h2{ margin:0 0 20px; }

.imgLayer{
  position:fixed; inset:0; z-index:5;
  display:none; justify-content:center; align-items:center;
  background:rgba(0,0,0,.6);
}
.imgStage{
  position:relative;
  width:min(1100px,96vw);
  aspect-ratio:2048/1152;
  background:#000;
  border-radius:14px;
  overflow:hidden;
  border: 2px solid #3b82f6;
}
.imgStage img{ position:absolute; inset:0; width:100%; height:100%; object-fit:contain; }
.hotspot{ position:absolute; cursor:pointer; background: rgba(255,255,255,0); }

.toast{
  position:fixed; left:50%; bottom:100px; transform:translateX(-50%);
  z-index:7; background:rgba(15,23,42,.85); padding:10px 20px;
  border-radius:12px; font-size:14px; display:none;
}

/* ğŸ“± æ‰‹æœºç«–å±é€‚é… */
@media (orientation: portrait){
  .bg, #bgVideo { height: 60vh; top: 5vh; }
  .chapter { top: 12px; left: 12px; font-size: 20px; }
  /* è§£å†³é‡å ï¼šå°† HUD ç§»è‡³åº•éƒ¨ */
  .hud {
    top: auto; right: 12px; bottom: 35px; left: 12px;
    justify-content: space-around;
    padding: 12px;
  }
}
</style>
</head>
<body>

<div class="bg">
  <video id="bgVideo" playsinline webkit-playsinline x5-playsinline preload="auto"></video>
  <div class="shade"></div>
</div>

<div class="chapter" id="chapterTitle">
  å‡†å¤‡ä¸­...
  <small id="chapterEn">LOADING</small>
</div>

<div class="hud">
  <div class="scoreBox">ç§¯åˆ†ï¼š<b id="score">0</b></div>
  <div class="timerBox">æ€»è®¡ç”¨æ—¶ï¼š<b id="timer">00:00</b></div>
</div>

<div class="imgLayer" id="imgLayer">
  <div class="imgStage" id="imgStage">
    <img id="qImg" src="" alt="question"/>
  </div>
</div>

<div class="gate" id="gate">
  <div class="gateCard">
    <h2 id="gateH2">å‡†å¤‡å¥½äº†å—ï¼Ÿ</h2>
    <button id="btnStart">å¼€å§‹æ¸¸æˆ â–¶</button>
  </div>
</div>

<div class="toast" id="toast"></div>
<audio id="bgm" loop preload="auto"></audio>

<script>
/* --- é…ç½®åŒº --- */
const STORE = "wedding_game_v2";
const BASE_URL = "https://haibing-wedding-video.oss-cn-chengdu.aliyuncs.com/";
const GLOBAL_BGM = BASE_URL + "love_story.mp3"; 
const GLOBAL_BGM_VOLUME = 0.35;

const CHAPTERS = [
  {
    id: "ch1", title: "ç¬¬ä¸€ç«  Â· åˆé€¢", en: "THE FIRST MEETING",
    videos: [BASE_URL + "chufeng_merge.mp4", BASE_URL + "cuoyiban1.mp4"],
    questions: [{
      id: "q_trash_sell", after: BASE_URL + "chufeng_merge.mp4", img: BASE_URL + "xuanbanzhang.png",
      hotspots: [
        { score: 0,  left:10, top:60, width:36, height:25, nextVideo: BASE_URL + "wrong_selection.mp4" },
        { score: 10, left:55, top:60, width:36, height:25, nextVideo: BASE_URL + "right_selection.mp4" }
      ]
    }],
    nextChapterId: "ch2"
  },
  {
    id: "ch2", title: "ç¬¬äºŒç«  Â· ç›¸è¯†", en: "GETTING TO KNOW YOU",
    videos: [BASE_URL + "mailaji.mp4", BASE_URL + "liulian.mp4", BASE_URL + "langsong.mp4"],
    questions: [
      { id: "q_ch2_jiasai", after: BASE_URL + "mailaji.mp4", img: BASE_URL + "trash_selling1.png",
        hotspots: [
          { score: 0,  left:10, top:60, width:36, height:25, nextVideo: BASE_URL + "wrong_selection.mp4" },
          { score: 10, left:55, top:60, width:36, height:25, nextVideo: BASE_URL + "right_selection.mp4" }
        ]
      },
      { id: "q_ch2_trash_selling", after: BASE_URL + "langsong.mp4", img: BASE_URL + "jiasai.png",
        hotspots: [
          { score: 10, left: 5,  top: 5, width: 40, height: 90, nextVideo: BASE_URL + "right_selection.mp4" },
          { score: 0,  left: 55, top: 5, width: 40, height: 90, nextVideo: BASE_URL + "wrong_selection.mp4" }
        ]
      }
    ],
    nextChapterId: "ch3"
  },
  {
    id: "ch3", title: "ç¬¬ä¸‰ç«  Â· å„è¡Œ", en: "FINDING OUR OWN PATHS",
    videos: [BASE_URL + "gexing_merge13.mp4", BASE_URL + "gexing_merge15.mp4"],
    questions: [{
      id: "q_ch3_1_work", after: BASE_URL + "gexing_merge13.mp4", img: BASE_URL + "gongzuo.png",
      hotspots: [
        { score: 0,  left:50, top:40, width:14, height:25, nextVideo: BASE_URL + "wrong_selection.mp4" },
        { score: 10, left:63, top:40, width:14, height:25, nextVideo: BASE_URL + "right_selection.mp4" },
        { score: 0,  left:76, top:40, width:14, height:25, nextVideo: BASE_URL + "wrong_selection.mp4" }
      ]
    }],
    nextChapterId: "ch4"
  },
  {
    id: "ch4", title: "ç¬¬å››ç«  Â· å†ä¼š", en: "REUNION",
    videos: [BASE_URL + "zaihui_merge11.mp4", BASE_URL + "zaihui5.mp4"],
    questions: [{
      id: "q_ch4_beibao", 
      after: BASE_URL + "zaihui_merge11.mp4", 
      img: BASE_URL + "beibao.png",
      hotspots: [
        { score: 0,  left: 3,   top: 72, width: 15, height: 28, nextVideo: BASE_URL + "wrong_selection.mp4" }, // A
        { score: 0,  left: 22,  top: 72, width: 15, height: 28, nextVideo: BASE_URL + "wrong_selection.mp4" }, // B
        { score: 0,  left: 41,  top: 72, width: 15, height: 28, nextVideo: BASE_URL + "wrong_selection.mp4" }, // C
        { score: 30, left: 60,  top: 72, width: 15, height: 28, nextVideo: BASE_URL + "right_selection.mp4" }, // D (æ­£ç¡®)
        { score: 0,  left: 79,  top: 72, width: 15, height: 28, nextVideo: BASE_URL + "wrong_selection.mp4" }  // E (è¡¥å›)
      ]
    }],
    nextChapterId: "ch5"
  },
  {
    id: "ch5", title: "ç¬¬äº”ç«  Â· å‘å‰", en: "MOVING FORWARD",
    videos: [BASE_URL + "xiangqian_merge.mp4", BASE_URL + "xiangqian11.mp4", BASE_URL + "xiangqian5.mp4"],
    questions: [{
      id: "q_ch5_xiangqian_guess", after: BASE_URL + "xiangqian_merge.mp4", img: BASE_URL + "yaoshi.png",
      hotspots: [
        { score: 0,  left: 0,  top: 0, width: 50, height: 100, nextVideo: BASE_URL + "wrong_selection.mp4" },
        { score: 30, left: 50, top: 0, width: 50, height: 100, nextVideo: BASE_URL + "right_selection.mp4" }
      ]
    }],
    nextChapterId: "ch6"
  },
  { id: "ch6", title: "ç¬¬å…­ç«  Â· ç»å¹´", en: "YEARS APART", videos: [BASE_URL + "jingnian_merge.mp4"], questions: [], nextChapterId: "ch7" },
  { id: "ch7", title: "ç¬¬ä¸ƒç«  Â· æ­¤åˆ»", en: "THIS MOMENT", videos: [BASE_URL + "cike1.mp4", BASE_URL + "cike2.mp4", BASE_URL + "cike3.mp4"], questions: [], nextChapterId: null }
];

/* --- æ ¸å¿ƒé€»è¾‘ --- */
const bgVideo = document.getElementById("bgVideo");
const bgm = document.getElementById("bgm");
const scoreEl = document.getElementById("score");
const timerEl = document.getElementById("timer");
const chapterTitle = document.getElementById("chapterTitle");
const chapterEn = document.getElementById("chapterEn");
const gate = document.getElementById("gate");
const imgLayer = document.getElementById("imgLayer");
const imgStage = document.getElementById("imgStage");
const qImg = document.getElementById("qImg");
const toast = document.getElementById("toast");

let curChapter = null, curVideoIndex = 0, endHandled = false, blockEnd = false;
let injectedActive = false, injectedReturnIndex = 0;

function switchVideo(url) {
  blockEnd = false; endHandled = false;
  bgVideo.pause();
  bgVideo.src = url;
  bgVideo.load();
  bgVideo.play().catch(e => console.log("Play blocked"));
}

function loadMainVideo(i) {
  if (!curChapter) return;
  if (i >= curChapter.videos.length) {
    gotoNextChapter();
    return;
  }
  curVideoIndex = i;
  switchVideo(curChapter.videos[curVideoIndex]);
}

function handleEnd() {
  if (blockEnd || endHandled) return;
  endHandled = true;
  if (injectedActive) {
    injectedActive = false;
    loadMainVideo(injectedReturnIndex);
    return;
  }
  const vidName = curChapter.videos[curVideoIndex];
  const q = (curChapter.questions || []).find(q => q.after === vidName);
  if (q && !isAnswered(curChapter.id, q.id)) {
    setTimeout(() => openQuestion(q), 100);
    return;
  }
  loadMainVideo(curVideoIndex + 1);
}

bgVideo.addEventListener("ended", handleEnd);

function openQuestion(q) {
  blockEnd = true; endHandled = true;
  bgVideo.pause();
  qImg.src = q.img;
  imgStage.querySelectorAll(".hotspot").forEach(n => n.remove());
  q.hotspots.forEach(h => {
    const div = document.createElement("div");
    div.className = "hotspot";
    div.style.cssText = `left:${h.left}%; top:${h.top}%; width:${h.width}%; height:${h.height}%;`;
    div.onclick = (e) => {
      e.stopPropagation();
      if (!isAnswered(curChapter.id, q.id)) {
        saveScore(loadScore() + h.score);
        markAnswered(curChapter.id, q.id);
      }
      imgLayer.style.display = "none";
      if (h.nextVideo) {
        injectedActive = true; injectedReturnIndex = curVideoIndex + 1;
        switchVideo(h.nextVideo);
      } else {
        loadMainVideo(curVideoIndex + 1);
      }
    };
    imgStage.appendChild(div);
  });
  imgLayer.style.display = "flex";
}

/* --- å·¥å…·å‡½æ•° --- */
function get(k){ return localStorage.getItem(`${STORE}:${k}`); }
function set(k,v){ localStorage.setItem(`${STORE}:${k}`, String(v)); }
function loadScore(){ return Number(get("score") || 0); }
function saveScore(v){ set("score", v); scoreEl.textContent = v; }
function isAnswered(chId, qid){ return get(`answered:${chId}:${qid}`) === "1"; }
function markAnswered(chId, qid){ set(`answered:${chId}:${qid}`, "1"); }
function showToast(msg){ toast.textContent = msg; toast.style.display="block"; setTimeout(()=>toast.style.display="none", 2500); }

let timerTick = null;
function updateTimerUI(){
  const st = Number(get("timerStart") || 0);
  const sp = Number(get("timerStop") || 0);
  if (!st){ timerEl.textContent = "00:00"; return; }
  const now = sp > 0 ? sp : Date.now();
  const elapsed = now - st;
  const s = Math.floor(elapsed/1000);
  timerEl.textContent = `${String(Math.floor(s/60)).padStart(2,"0")}:${String(s%60).padStart(2,"0")}`;
}

function startChapterById(chId) {
  curChapter = CHAPTERS.find(c => c.id === chId);
  chapterTitle.childNodes[0].nodeValue = curChapter.title + " ";
  chapterEn.textContent = curChapter.en;
  loadMainVideo(0);
}

function gotoNextChapter() {
  if (!curChapter.nextChapterId) {
    if (!get("timerStop")) set("timerStop", Date.now());
    if (timerTick) clearInterval(timerTick);
    updateTimerUI();
    showToast("å…¨å‰§ç»ˆï¼æ„Ÿè°¢æ‚¨çš„è§‚çœ‹");
    return;
  }
  const next = CHAPTERS.find(c => c.id === curChapter.nextChapterId);
  gate.style.display = "flex";
  document.getElementById("gateH2").textContent = `è¿›å…¥ä¸‹ä¸€æ®µï¼š${next.title}`;
  document.getElementById("btnStart").onclick = () => {
    gate.style.display = "none";
    startChapterById(next.id);
  };
}

// åˆå§‹åŒ–ç§¯åˆ†æ˜¾ç¤º
saveScore(loadScore());

document.getElementById("btnStart").onclick = () => {
  gate.style.display = "none";
  if (!bgm.src || bgm.src === "") {
    bgm.src = GLOBAL_BGM;
    bgm.volume = GLOBAL_BGM_VOLUME;
    bgm.play().catch(e => console.log("BGM Audio blocked"));
  }
  bgVideo.muted = false;

  if (!get("timerStart")) set("timerStart", Date.now());
  
  if (!get("timerStop")) {
    if (!timerTick) timerTick = setInterval(updateTimerUI, 1000);
  } else {
    updateTimerUI();
  }
  
  // âœ… å§‹ç»ˆä»ç¬¬ä¸€ç« å¼€å§‹é‡æ’­
  startChapterById("ch1");
};

// é¡µé¢åŠ è½½è‡ªåŠ¨æ›´æ–°è®¡æ—¶
updateTimerUI();
  // ç§˜å¯†é‡ç½®é€»è¾‘ï¼šè¿ç»­ç‚¹å‡»å·¦ä¸Šè§’ç« èŠ‚æ ‡é¢˜ 5 æ¬¡è§¦å‘é‡ç½®
let debugClickCount = 0;
document.getElementById("chapterTitle").onclick = () => {
  debugClickCount++;
  if (debugClickCount >= 5) {
    if (confirm("ã€å¼€å‘è€…æµ‹è¯•ã€‘ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å¹¶é‡æ–°å¼€å§‹å—ï¼Ÿ")) {
      localStorage.clear();
      location.reload();
    }
    debugClickCount = 0;
  }
};
</script>
</body>
</html>
